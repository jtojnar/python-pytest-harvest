


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.2">
    
    
      
        <title>pytest_harvest</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.a2408e81.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pytest-harvest" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="." title="pytest_harvest" class="md-header-nav__button md-logo" aria-label="pytest_harvest">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            pytest_harvest
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Home
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="pytest_harvest" class="md-nav__button md-logo" aria-label="pytest_harvest">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    pytest_harvest
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Home
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-collecting-fixture-instances" class="md-nav__link">
    a- Collecting fixture instances
  </a>
  
    <nav class="md-nav" aria-label="a- Collecting fixture instances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#collecting-fixture-views" class="md-nav__link">
    Collecting fixture views
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-collecting-test-artifacts" class="md-nav__link">
    b- Collecting test artifacts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-collecting-a-synthesis" class="md-nav__link">
    c- Collecting a synthesis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-collecting-all-at-once" class="md-nav__link">
    d- collecting all at once
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e-advanced-usage" class="md-nav__link">
    e- advanced usage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compliance-with-the-pytest-ecosystem" class="md-nav__link">
    Compliance with the pytest ecosystem
  </a>
  
    <nav class="md-nav" aria-label="Compliance with the pytest ecosystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest-x-dist" class="md-nav__link">
    pytest x-dist
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-features-benefits" class="md-nav__link">
    Main features / benefits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav" aria-label="See Also">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="api_reference/" title="API reference" class="md-nav__link">
      API reference
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="advanced_usage/" title="Advanced Usage" class="md-nav__link">
      Advanced Usage
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav" aria-label="Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-collecting-fixture-instances" class="md-nav__link">
    a- Collecting fixture instances
  </a>
  
    <nav class="md-nav" aria-label="a- Collecting fixture instances">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#collecting-fixture-views" class="md-nav__link">
    Collecting fixture views
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-collecting-test-artifacts" class="md-nav__link">
    b- Collecting test artifacts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#c-collecting-a-synthesis" class="md-nav__link">
    c- Collecting a synthesis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#d-collecting-all-at-once" class="md-nav__link">
    d- collecting all at once
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#e-advanced-usage" class="md-nav__link">
    e- advanced usage
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compliance-with-the-pytest-ecosystem" class="md-nav__link">
    Compliance with the pytest ecosystem
  </a>
  
    <nav class="md-nav" aria-label="Compliance with the pytest ecosystem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pytest-x-dist" class="md-nav__link">
    pytest x-dist
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-features-benefits" class="md-nav__link">
    Main features / benefits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav" aria-label="See Also">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/smarie/python-pytest-harvest/edit/master/docs/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="pytest-harvest">pytest-harvest<a class="headerlink" href="#pytest-harvest" title="Permanent link">&para;</a></h1>
<p><em>Store data created during your <code>pytest</code> tests execution, and retrieve it at the end of the session, e.g. for applicative benchmarking purposes.</em></p>
<p><a href="https://pypi.python.org/pypi/pytest-harvest/"><img alt="Python versions" src="https://img.shields.io/pypi/pyversions/pytest-harvest.svg" /></a> <a href="https://travis-ci.org/smarie/python-pytest-harvest"><img alt="Build Status" src="https://travis-ci.org/smarie/python-pytest-harvest.svg?branch=master" /></a> <a href="https://smarie.github.io/python-pytest-harvest/junit/report.html"><img alt="Tests Status" src="https://smarie.github.io/python-pytest-harvest/junit/junit-badge.svg?dummy=8484744" /></a> <a href="https://codecov.io/gh/smarie/python-pytest-harvest"><img alt="codecov" src="https://codecov.io/gh/smarie/python-pytest-harvest/branch/master/graph/badge.svg" /></a></p>
<p><a href="https://smarie.github.io/python-pytest-harvest/"><img alt="Documentation" src="https://img.shields.io/badge/doc-latest-blue.svg" /></a> <a href="https://pypi.python.org/pypi/pytest-harvest/"><img alt="PyPI" src="https://img.shields.io/pypi/v/pytest-harvest.svg" /></a> <a href="https://pepy.tech/project/pytest-harvest"><img alt="Downloads" src="https://pepy.tech/badge/pytest-harvest" /></a> <a href="https://pepy.tech/project/pytest-harvest"><img alt="Downloads per week" src="https://pepy.tech/badge/pytest-harvest/week" /></a> <a href="https://github.com/smarie/python-pytest-harvest/stargazers"><img alt="GitHub stars" src="https://img.shields.io/github/stars/smarie/python-pytest-harvest.svg" /></a></p>
<div class="admonition success">
<p class="admonition-title">now compliant with <code>pytest-xdist</code>! <a href="#pytest-x-dist">check it out</a></p>
</div>
<p><code>pytest</code> is a great tool to write test logic once and then generate multiple tests from <em>parameters</em>. Its <em>fixture</em> mechanism provides a cool way to inject dependencies in your tests.</p>
<p>At the end of a test session, you can already <strong>collect various data</strong> about the tests that have been run. But it is a bit cumbersome to get it right, and requires you to write a plugin (see <a href="https://docs.pytest.org/en/latest/example/simple.html#making-test-result-information-available-in-fixtures">this advice</a>).</p>
<p>Besides, as opposed to <em>parameters</em> (<code>@pytest.mark.parametrize</code>), <code>pytest</code> purposedly does not keep <em>fixtures</em> (<code>@pytest.fixture</code>) in memory, because in general that would just be a waste of memory. Therefore you are currently <strong>not able to retrieve fixture values at the end of the session</strong>.</p>
<p>Finally, what about other kind of <strong>applicative results</strong> that you produce during test execution ? There is no current mechanism in <code>pytest</code> to manage that.</p>
<p>With <code>pytest-harvest</code>:</p>
<ul>
<li>
<p>you can <strong>store all instances of a fixture</strong> with <code>@saved_fixture</code>, so that they remain available until the end of the test session. If you're only interested in some aspects of the fixture, you can store "<em>views</em>" instead.</p>
</li>
<li>
<p>you can use the special <code>results_bag</code> fixture to <strong>collect interesting results</strong> within your tests.</p>
</li>
<li>
<p>you can use the special <code>[session/module]_results_[dct/df]</code> fixtures to easily <strong>collect all available data</strong> at the end of a session or module, without having to register <code>pytest</code> hooks. The status, duration and parameters of all tests become easily available both as dictionary or <code>pandas</code> dataframe, and your saved fixtures and results are there too. </p>
</li>
<li>
<p>you can create your own variants of the above thanks to the API, for more customized data collection and synthesis.</p>
</li>
</ul>
<p>With all that, you can now easily create <strong>applicative benchmarks</strong>. See <a href="https://smarie.github.io/pytest-patterns/">pytest-patterns</a> for an example of data science benchmark.</p>
<h2 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>&gt; pip install pytest_harvest
</code></pre></div>


<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<h3 id="a-collecting-fixture-instances">a- Collecting fixture instances<a class="headerlink" href="#a-collecting-fixture-instances" title="Permanent link">&para;</a></h3>
<p>Simply use the <code>@saved_fixture</code> decorator on your fixtures to declare that their instances must be saved. By default they are saved in a session-scoped <code>fixture_store</code> fixture that you can therefore grab and inspect in other tests or in any compliant pytest entry point:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nd">@saved_fixture</span>
<span class="k">def</span> <span class="nf">person</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy fixture, parametrized so that it has two instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;world&quot;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;self&quot;</span>

<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">person</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy test, executed for each `person` fixture available</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   hello, &#39;</span> <span class="o">+</span> <span class="n">person</span> <span class="o">+</span> <span class="s1">&#39; !&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">fixture_store</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this test we inspect the contents of the fixture store so far,</span>
<span class="sd">    and check that the &#39;person&#39; entry contains a dict &lt;test_id&gt;: &lt;person&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print the keys in the store</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Available `fixture_store` keys:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fixture_store</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># print what is available for the &#39;person&#39; entry</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Contents of `fixture_store[&#39;person&#39;]`:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fixture_store</span><span class="p">[</span><span class="s1">&#39;person&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
</code></pre></div>


<p>Let's execute it:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; pytest -s -v

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
...
collecting ... collected <span class="m">3</span> items
test_doc_basic_saved_fixture.py::test_foo<span class="o">[</span><span class="m">0</span><span class="o">]</span> 
   hello, world !
PASSED
test_doc_basic_saved_fixture.py::test_foo<span class="o">[</span><span class="m">1</span><span class="o">]</span> 
   hello, self !
PASSED
test_doc_basic_saved_fixture.py::test_synthesis 
   Available <span class="sb">`</span>fixture_store<span class="sb">`</span> keys:
    - <span class="s1">&#39;person&#39;</span>

   Contents of <span class="sb">`</span>fixture_store<span class="o">[</span><span class="s1">&#39;person&#39;</span><span class="o">]</span><span class="sb">`</span>:
    - <span class="s1">&#39;test_doc_basic_saved_fixture.py::test_foo[0]&#39;</span>: world
    - <span class="s1">&#39;test_doc_basic_saved_fixture.py::test_foo[1]&#39;</span>: self
<span class="nv">PASSED</span>

<span class="o">==========================</span> <span class="m">3</span> passed in <span class="m">0</span>.09 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>As you can see, the <code>fixture_store</code> contains one entry for each saved fixture, and this entry's value is a dictionary of <code>{&lt;test_id&gt;: &lt;fixture_value&gt;}</code>.  We will see <a href="#d-collecting-all-at-once">below</a> how to combine this information with information already available in pytest (test status, duration...).</p>
<h4 id="collecting-fixture-views">Collecting fixture views<a class="headerlink" href="#collecting-fixture-views" title="Permanent link">&para;</a></h4>
<p>Sometimes you are not interested in storing the whole fixture but maybe just some aspect of it. For example maybe the fixture is a huge dataset, and you just wish to remember a few characteristics about it.</p>
<p>Simply use the <code>views=</code> argument in <code>@saved_fixture</code> to save views instead of the fixture itself. That argument should contain a dictionary of <code>{&lt;view_key&gt;: &lt;view_creation_function&gt;}</code>.</p>
<p>In the previous example if we only want to save the first and last character of the <code>person</code> fixture, we can do:</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nd">@saved_fixture</span><span class="p">(</span><span class="n">views</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;person_initial&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                      <span class="s1">&#39;person_last_char&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
<span class="k">def</span> <span class="nf">person</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy fixture, parametrized so that it has two instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;world&quot;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;self&quot;</span>
</code></pre></div>


<p>The fixture store will then contain as many entries as there are views.</p>
<h3 id="b-collecting-test-artifacts">b- Collecting test artifacts<a class="headerlink" href="#b-collecting-test-artifacts" title="Permanent link">&para;</a></h3>
<p>Simply use the <code>results_bag</code> fixture in your tests and you'll be able to store items in it. This object behaves like a munch: if you create/read a field it will create/read a dictionary entry. By default the <code>results_bag</code> fixture is stored in the <code>fixture_store</code> so you can retrieve it at the end as shown previously.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">results_bag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy test, parametrized so that it is executed twice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   hello, &#39;</span> <span class="o">+</span> <span class="n">p</span> <span class="o">+</span> <span class="s1">&#39; !&#39;</span><span class="p">)</span>

    <span class="c1"># Let&#39;s store some things in the results bag</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">nb_letters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">fixture_store</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this test we inspect the contents of the fixture store so far, and </span>
<span class="sd">    check that the &#39;results_bag&#39; entry contains a dict &lt;test_id&gt;: &lt;results_bag&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print the keys in the store</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Available `fixture_store` keys:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fixture_store</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># print what is available for the &#39;results_bag&#39; entry</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Contents of `fixture_store[&#39;results_bag&#39;]`:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fixture_store</span><span class="p">[</span><span class="s1">&#39;results_bag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;:&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      - &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">))</span>
</code></pre></div>


<p>Let's execute it:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; pytest -s -v

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
...
collecting ... collected <span class="m">3</span> items
test_doc_basic_results_bag.py::test_foo<span class="o">[</span>world<span class="o">]</span> 
   hello, world !
PASSED
test_doc_basic_results_bag.py::test_foo<span class="o">[</span>self<span class="o">]</span> 
   hello, self !
PASSED
test_doc_basic_results_bag.py::test_synthesis 
   Available <span class="sb">`</span>fixture_store<span class="sb">`</span> keys:
    - <span class="s1">&#39;results_bag&#39;</span>

   Contents of <span class="sb">`</span>fixture_store<span class="o">[</span><span class="s1">&#39;results_bag&#39;</span><span class="o">]</span><span class="sb">`</span>:
    - <span class="s1">&#39;test_doc_basic_results_bag.py::test_foo[world]&#39;</span>:
      - <span class="s1">&#39;nb_letters&#39;</span>: <span class="m">5</span>
      - <span class="s1">&#39;current_time&#39;</span>: <span class="m">2018</span>-12-08T22:20:10.695791
    - <span class="s1">&#39;test_doc_basic_results_bag.py::test_foo[self]&#39;</span>:
      - <span class="s1">&#39;nb_letters&#39;</span>: <span class="m">4</span>
      - <span class="s1">&#39;current_time&#39;</span>: <span class="m">2018</span>-12-08T22:20:10.700791
<span class="nv">PASSED</span>

<span class="o">==========================</span> <span class="m">3</span> passed in <span class="m">0</span>.05 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>As in previous example, the <code>fixture_store</code> contains one entry for <code>'results_bag'</code>, and this entry's value is a dictionary of <code>{&lt;test_id&gt;: &lt;results_bag&gt;}</code>. We can therefore access all values stored within each test (here, <code>nb_letters</code> and <code>current_time</code>). </p>
<p>We will see <a href="#d-collecting-all-at-once">below</a> how to combine this information with information already available in pytest.</p>
<h3 id="c-collecting-a-synthesis">c- Collecting a synthesis<a class="headerlink" href="#c-collecting-a-synthesis" title="Permanent link">&para;</a></h3>
<p><strong>as a</strong> <code>dict</code></p>
<p>Simply use the <code>module_results_dct</code> fixture to get a dictionary containing the test results <em>in that module</em>, <em>so far</em>. You can use this fixture in a test as shown below (<code>test_synthesis</code>) or in any compliant pytest entry point. </p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;self&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy test, parametrized so that it is executed twice</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   hello, &#39;</span> <span class="o">+</span> <span class="n">p</span> <span class="o">+</span> <span class="s1">&#39; !&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">module_results_dct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this test we just look at the synthesis of all tests </span>
<span class="sd">    executed before it, in that module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print the keys in the synthesis dictionary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Available `module_results_dct` keys:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">module_results_dct</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

    <span class="c1"># print what is available for a single test</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Contents of &#39;test_foo[world]&#39;:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">module_results_dct</span><span class="p">[</span><span class="s1">&#39;test_foo[world]&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;status_details&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    - &#39;</span><span class="si">%s</span><span class="s2">&#39;:&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      - &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="p">))</span>
</code></pre></div>


<p>Let's execute it:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; pytest -s -v

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
...
collecting ... collected <span class="m">3</span> items
test_doc_basic.py::test_foo<span class="o">[</span>world<span class="o">]</span>
   hello, world !
PASSED
test_doc_basic.py::test_foo<span class="o">[</span>self<span class="o">]</span>
   hello, self !
PASSED
test_doc_basic.py::test_synthesis 
   Available <span class="sb">`</span>module_results_dct<span class="sb">`</span> keys:
    - test_foo<span class="o">[</span>world<span class="o">]</span>
    - test_foo<span class="o">[</span>self<span class="o">]</span>

   Contents of <span class="s1">&#39;test_foo[world]&#39;</span>:
    - <span class="s1">&#39;pytest_obj&#39;</span>: &lt;<span class="k">function</span> test_foo at 0x0000000005A7DEA0&gt;
    - <span class="s1">&#39;status&#39;</span>: passed
    - <span class="s1">&#39;duration_ms&#39;</span>: <span class="m">500</span>.0283718109131
    - <span class="s1">&#39;status_details&#39;</span>:
      - <span class="s1">&#39;setup&#39;</span>: <span class="o">(</span><span class="s1">&#39;passed&#39;</span>, <span class="m">3</span>.0002593994140625<span class="o">)</span>
      - <span class="s1">&#39;call&#39;</span>: <span class="o">(</span><span class="s1">&#39;passed&#39;</span>, <span class="m">500</span>.0283718109131<span class="o">)</span>
      - <span class="s1">&#39;teardown&#39;</span>: <span class="o">(</span><span class="s1">&#39;passed&#39;</span>, <span class="m">2</span>.0003318786621094<span class="o">)</span>
    - <span class="s1">&#39;params&#39;</span>: OrderedDict<span class="o">([(</span><span class="s1">&#39;p&#39;</span>, <span class="s1">&#39;world&#39;</span><span class="o">)])</span>
    - <span class="s1">&#39;fixtures&#39;</span>: OrderedDict<span class="o">()</span>
<span class="nv">PASSED</span>

<span class="o">==========================</span> <span class="m">3</span> passed in <span class="m">0</span>.05 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>As you can see, for each test node id you get a dictionary containing</p>
<ul>
<li><code>'pytest_obj'</code>the object containing the test code</li>
<li><code>'status'</code> the status of the test (passed/skipped/failed)</li>
<li><code>'duration_ms'</code> the duration of the test as measured by pytest (only the "call" step is measured here, not setup nor teardown times)</li>
<li><code>'status_details'</code>: details (status and duration) for each pytest phase</li>
<li><code>'params'</code>the parameters used in this test (both in the test function AND the fixtures)</li>
<li><code>'fixtures'</code> the saved fixture instances (not parameters) for this test. Here we see the saved fixtures and result bags, if any (see <a href="#d-collecting-all-at-once">below</a> for a complete example) </li>
</ul>
<p>Note: if you need the synthesis to contain all tests of the <em>session</em> instead of just the current <em>module</em>, use fixture <code>session_results_dct</code> instead.</p>
<p><strong>as a</strong> <code>DataFrame</code></p>
<p>Simply use the <code>module_results_df</code> fixture instead of <code>module_results_dct</code> (note the <code>df</code> suffix instead of <code>dct</code>) to get the same contents as a table, which might be more convenient for statistics and aggregations of all sorts. Note: you have to have <code>pandas</code> installed for this fixture to be available.</p>
<p>Replacing the above <code>test_synthesis</code> function with </p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">module_results_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this variant we use the &#39;dataframe&#39; fixture</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print the synthesis dataframe</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   `module_results_df` dataframe:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">module_results_df</span><span class="p">)</span>
</code></pre></div>


<p>yields:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; pytest -s -v

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
...
collecting ... collected <span class="m">3</span> items
test_doc_basic.py::test_foo<span class="o">[</span>world<span class="o">]</span> 
   hello, world !
PASSED
test_doc_basic.py::test_foo<span class="o">[</span>self<span class="o">]</span> 
   hello, self !
PASSED
test_doc_basic.py::test_synthesis 
   <span class="sb">`</span>module_results_df<span class="sb">`</span> dataframe:

                 status  duration_ms      p
test_id                                    
test_foo<span class="o">[</span>world<span class="o">]</span>  passed   <span class="m">500</span>.028610  world
test_foo<span class="o">[</span>self<span class="o">]</span>   passed   <span class="m">400</span>.022745   self
<span class="nv">PASSED</span>

<span class="o">==========================</span> <span class="m">3</span> passed in <span class="m">0</span>.05 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>As can be seen above, each row in the dataframe corresponds to a test (the index is the test id), and the various information are presented in columns. As opposed to the dictionary version, status details are not provided.</p>
<p>Note: as for the dict version, if you need the synthesis to contain all tests of the <em>session</em> instead of just the current <em>module</em>, use fixture <code>session_results_df</code> instead.</p>
<h3 id="d-collecting-all-at-once">d- collecting all at once<a class="headerlink" href="#d-collecting-all-at-once" title="Permanent link">&para;</a></h3>
<p>We have seen first how to collect <em>saved fixtures</em>, and <em>test artifacts</em> thanks to results bags. Then we saw how to collect <em>pytest status and duration information, as well as parameters</em>. </p>
<p>You may now wonder how to collect all of this in a single handy object ? Well, the answer is quite simple: you have nothing more to do. Indeed, the <code>[module/session]_results_[dct/df]</code> fixtures that we saw in previous chapter will by default contain <em>all</em> saved fixtures and results bags. </p>
<p>Let's try it:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nd">@saved_fixture</span>
<span class="k">def</span> <span class="nf">person</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy fixture, parametrized so that it has two instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;world&quot;</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;self&quot;</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;double_sleep_time&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">double_sleep_time</span><span class="p">,</span> <span class="n">person</span><span class="p">,</span> <span class="n">results_bag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dummy test, parametrized so that it is executed twice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   hello, &#39;</span> <span class="o">+</span> <span class="n">person</span> <span class="o">+</span> <span class="s1">&#39; !&#39;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">double_sleep_time</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Let&#39;s store some things in the results bag</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">nb_letters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">current_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">module_results_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    In this test we just look at the synthesis of all tests</span>
<span class="sd">    executed before it, in that module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print the synthesis dataframe</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   `module_results_df` dataframe:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># we use &#39;tabulate&#39; for a nicer output format</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">module_results_df</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;pipe&quot;</span><span class="p">))</span>
</code></pre></div>


<p>yields</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; pytest -s -v

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
...
collecting ... collected <span class="m">5</span> items
test_doc_basic_df_all.py::test_foo<span class="o">[</span><span class="m">0</span>-False<span class="o">]</span> 
test_doc_basic_df_all.py::test_foo<span class="o">[</span><span class="m">0</span>-True<span class="o">]</span> 
test_doc_basic_df_all.py::test_foo<span class="o">[</span><span class="m">1</span>-False<span class="o">]</span> 
test_doc_basic_df_all.py::test_foo<span class="o">[</span><span class="m">1</span>-True<span class="o">]</span> 
test_doc_basic_df_all.py::test_synthesis 
   hello, world !
PASSED
   hello, world !
PASSED
   hello, self !
PASSED
   hello, self !
PASSED
   <span class="sb">`</span>module_results_df<span class="sb">`</span> dataframe:

<span class="p">|</span> test_id           <span class="p">|</span> pytest_obj                                <span class="p">|</span> status   <span class="p">|</span>   duration_ms <span class="p">|</span> double_sleep_time   <span class="p">|</span>   person_param <span class="p">|</span> person   <span class="p">|</span>   nb_letters <span class="p">|</span> current_time               <span class="p">|</span>
<span class="p">|</span>:------------------<span class="p">|</span>:------------------------------------------<span class="p">|</span>:---------<span class="p">|</span>--------------:<span class="p">|</span>:--------------------<span class="p">|</span>---------------:<span class="p">|</span>:---------<span class="p">|</span>-------------:<span class="p">|</span>:---------------------------<span class="p">|</span>
<span class="p">|</span> test_foo<span class="o">[</span><span class="m">0</span>-False<span class="o">]</span> <span class="p">|</span> &lt;<span class="k">function</span> test_foo at 0x0000000004F8C488&gt; <span class="p">|</span> passed   <span class="p">|</span>       <span class="m">500</span>.029 <span class="p">|</span> False               <span class="p">|</span>              <span class="m">0</span> <span class="p">|</span> world    <span class="p">|</span>            <span class="m">5</span> <span class="p">|</span> <span class="m">2018</span>-12-10T22:06:32.279561 <span class="p">|</span>
<span class="p">|</span> test_foo<span class="o">[</span><span class="m">0</span>-True<span class="o">]</span>  <span class="p">|</span> &lt;<span class="k">function</span> test_foo at 0x0000000004F8C488&gt; <span class="p">|</span> passed   <span class="p">|</span>      <span class="m">1000</span>.06  <span class="p">|</span> True                <span class="p">|</span>              <span class="m">0</span> <span class="p">|</span> world    <span class="p">|</span>            <span class="m">5</span> <span class="p">|</span> <span class="m">2018</span>-12-10T22:06:33.283618 <span class="p">|</span>
<span class="p">|</span> test_foo<span class="o">[</span><span class="m">1</span>-False<span class="o">]</span> <span class="p">|</span> &lt;<span class="k">function</span> test_foo at 0x0000000004F8C488&gt; <span class="p">|</span> passed   <span class="p">|</span>       <span class="m">400</span>.023 <span class="p">|</span> False               <span class="p">|</span>              <span class="m">1</span> <span class="p">|</span> self     <span class="p">|</span>            <span class="m">4</span> <span class="p">|</span> <span class="m">2018</span>-12-10T22:06:33.687641 <span class="p">|</span>
<span class="p">|</span> test_foo<span class="o">[</span><span class="m">1</span>-True<span class="o">]</span>  <span class="p">|</span> &lt;<span class="k">function</span> test_foo at 0x0000000004F8C488&gt; <span class="p">|</span> passed   <span class="p">|</span>       <span class="m">800</span>.046 <span class="p">|</span> True                <span class="p">|</span>              <span class="m">1</span> <span class="p">|</span> self     <span class="p">|</span>            <span class="m">4</span> <span class="p">|</span> <span class="m">2018</span>-12-10T22:06:34.491687 <span class="p">|</span>
<span class="nv">PASSED</span>

<span class="o">==========================</span> <span class="m">5</span> passed in <span class="m">3</span>.87 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>So we see here that we get all the information in a single handy table object: for each test, we get its status, duration, parameters (<code>double_sleep_time</code>, <code>person_param</code>), fixtures (<code>person</code>) and results (<code>nb_letters</code>, <code>current_time</code>).</p>
<p>Of course you can still get the same information as a dictionary, and chose to get it for the whole session or for a specific module (see previous <a href="#c-collecting-a-synthesis">chapter</a>). </p>
<h3 id="e-advanced-usage">e- advanced usage<a class="headerlink" href="#e-advanced-usage" title="Permanent link">&para;</a></h3>
<p>All the behaviours described above are pre-wired using fixtures, to help most users getting started. For each fixture described above there is an equivalent method in <code>pytest-harvest</code> <a href="api_reference/#associated-getter-functions">API</a>, so that you may access the same information from within a pytest hook such as <code>pytest_sessionfinish(session)</code>:</p>
<ul>
<li><code>fixture_store</code> fixture: <code>get_fixture_store(session)</code></li>
<li><code>module_results_dct</code> fixture: <code>get_module_results_dct(session, module_name)</code></li>
<li><code>module_results_df</code> fixture: <code>get_module_results_df(session, module_name)</code></li>
<li><code>session_results_dct</code> fixture: <code>get_session_results_dct(session)</code></li>
<li><code>session_results_df</code> fixture: <code>get_session_results_df(session)</code></li>
</ul>
<p>Finally, these fixtures and equivalent methods are nothing but pre-wiring of more generic capabilities, that are offered in this library as well. So if these pre-wired objects do not suit your needs and you wish to create <strong>custom synthesis</strong>, <strong>custom store objects</strong>, <strong>custom results bags</strong>... see <a href="./advanced_usage">advanced usage page</a>.</p>
<h2 id="compliance-with-the-pytest-ecosystem">Compliance with the pytest ecosystem<a class="headerlink" href="#compliance-with-the-pytest-ecosystem" title="Permanent link">&para;</a></h2>
<p>This plugin mostly relies on the fixtures mechanism and the <code>pytest_runtest_makereport</code> hook. It should therefore be quite portable across pytest versions (at least it is tested against pytest 2, 3, 4, 5, for both python 2 and 3).</p>
<h3 id="pytest-x-dist">pytest x-dist<a class="headerlink" href="#pytest-x-dist" title="Permanent link">&para;</a></h3>
<p>You may wish to rely on <code>pytest-xdist</code> to parallelize/distribute your tests. In that case, you can not rely on the <code>[module/session]_results_[dct/df]</code> fixtures described previously to collect your synthesis because as of today there is no way to ensure that these methods will run last on the workers, and to run them at all on the master. So instead of using these fixtures, simply use the equivalent methods <code>get_[module/session]_results_[dct/df](session, [module_name])</code> in a pytest hook, and <code>pytest-harvest</code> will take care of the rest.</p>
<p>More precisely, when <code>pytest-xdist</code> is used to distribute tests, worker node results are automatically stored by <code>pytest-harvest</code> in a file at the end of their respective pytest session using pickle, in a temporary <code>.xdist_harvested/</code> folder. These results are automatically retrieved and consolidated when any of the <code>get_[module/session]_results_[dct/df]</code> method is called from the master node. Finally, the temporary folder is deleted at the end of master node session. You can use the <code>get_[module/session]_results_[dct/df]</code> methods in any pytest hook on the "master" node, for example in the <code>pytest_sessionfinish</code> hook. The methods continue to work on worker nodes, so to know if you are in the master node, a <code>is_main_process</code> function is provided.</p>
<p>Below is an example of <code>conftest.py</code> that works both <em>with</em> and <em>without</em> <code>pytest-xdist</code> enabled, and within both master an worker nodes:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">is_main_process</span><span class="p">,</span> <span class="n">get_xdist_worker_id</span><span class="p">,</span> \
                           <span class="n">get_session_results_df</span>

<span class="k">def</span> <span class="nf">pytest_sessionfinish</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gather all results and save them to a csv. </span>
<span class="sd">    Works both on worker and master nodes, and also with xdist disabled&quot;&quot;&quot;</span>

    <span class="n">session_results_df</span> <span class="o">=</span> <span class="n">get_session_results_df</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span> <span class="k">if</span> <span class="n">is_main_process</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">else</span> <span class="n">get_xdist_worker_id</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">session_results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;results_</span><span class="si">%s</span><span class="s1">.csv&#39;</span> <span class="o">%</span> <span class="n">suffix</span><span class="p">)</span>
</code></pre></div>


<p>Note: you can also do the persist/restore operation yourself using the hooks provided. See <a href="https://github.com/smarie/python-pytest-harvest/blob/master/pytest_harvest/newhooks.py"><code>newhooks</code></a> for details. Below is a <code>contest.py</code> example doing the same than the default behaviour, but with a different temporary folder:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">warning</span>

<span class="c1"># Define the folder in which temporary worker&#39;s results will be stored</span>
<span class="n">RESULTS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./.xdist_results/&#39;</span><span class="p">)</span>
<span class="n">RESULTS_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pytest_harvest_xdist_init</span><span class="p">():</span>
    <span class="c1"># reset the recipient folder</span>
    <span class="k">if</span> <span class="n">RESULTS_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">rmtree</span><span class="p">(</span><span class="n">RESULTS_PATH</span><span class="p">)</span>
    <span class="n">RESULTS_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">pytest_harvest_xdist_worker_dump</span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">session_items</span><span class="p">,</span> <span class="n">fixture_store</span><span class="p">):</span>
    <span class="c1"># persist session_items and fixture_store in the file system</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">RESULTS_PATH</span> <span class="o">/</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pkl&#39;</span> <span class="o">%</span> <span class="n">worker_id</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">session_items</span><span class="p">,</span> <span class="n">fixture_store</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error while pickling worker </span><span class="si">%s</span><span class="s2">&#39;s harvested results: &quot;</span> 
                    <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">pytest_harvest_xdist_load</span><span class="p">():</span>
    <span class="c1"># restore the saved objects from file system</span>
    <span class="n">workers_saved_material</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pkl_file</span> <span class="ow">in</span> <span class="n">RESULTS_PATH</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.pkl&#39;</span><span class="p">):</span>
        <span class="n">wid</span> <span class="o">=</span> <span class="n">pkl_file</span><span class="o">.</span><span class="n">stem</span>
        <span class="k">with</span> <span class="n">pkl_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">workers_saved_material</span><span class="p">[</span><span class="n">wid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">workers_saved_material</span>

<span class="k">def</span> <span class="nf">pytest_harvest_xdist_cleanup</span><span class="p">():</span>
    <span class="c1"># delete all temporary pickle files</span>
    <span class="n">rmtree</span><span class="p">(</span><span class="n">RESULTS_PATH</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>


<h2 id="main-features-benefits">Main features / benefits<a class="headerlink" href="#main-features-benefits" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>Collect test execution information easily</strong>: with the default <code>[module/session]_results_[dct/df]</code> fixtures, and with <code>get_session_synthesis_dct(session)</code> (advanced users), you can collect all the information you need, without the hassle of writing hooks. </p>
</li>
<li>
<p><strong>Store selected fixtures declaratively</strong>: simply decorate your fixture with <code>@saved_fixture</code> and all fixture values will be stored in the default storage. You can use the advanced <code>@saved_fixture(store)</code> to customize the storage (a variable or another fixture).</p>
</li>
<li>
<p><strong>Collect test artifacts</strong>: simply use the <code>results_bag</code> fixture to start collecting results from your tests. You can also create your own "results bags" fixtures (advanced). It makes it very easy to create applicative benchmarks, for example for <a href="https://smarie.github.io/pytest-patterns/">data science</a>.</p>
</li>
<li>
<p><strong>Highly configurable</strong>: storage object (for storing fixtures) or results bag objects (for collecting results from tests) can be of any object type of your choice. For results bags, a default type is provided that behaves like a "munch" (both a dictionary and an object). See <a href="./advanced_usage">advanced usage page</a>.</p>
</li>
</ul>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.pytest.org/en/latest/parametrize.html">pytest documentation on parametrize</a></li>
<li><a href="https://docs.pytest.org/en/latest/fixture.html">pytest documentation on fixtures</a></li>
<li><a href="https://smarie.github.io/pytest-patterns/">pytest-patterns</a>, to go further and create for example a data science benchmark by combining this plugin with others.</li>
</ul>
<h3 id="others">Others<a class="headerlink" href="#others" title="Permanent link">&para;</a></h3>
<p><em>Do you like this library ? You might also like <a href="https://github.com/smarie/OVERVIEW#python">my other python libraries</a></em> </p>
<h2 id="want-to-contribute">Want to contribute ?<a class="headerlink" href="#want-to-contribute" title="Permanent link">&para;</a></h2>
<p>Details on the github page: <a href="https://github.com/smarie/python-pytest-harvest">https://github.com/smarie/python-pytest-harvest</a></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
        
          <a href="api_reference/" title="API reference" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                API reference
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copied": "Copied to clipboard", "search.result.one": "1 matching document", "search.config.pipeline": "trimmer, stopWordFilter", "clipboard.copy": "Copy to clipboard", "search.config.separator": "[\\s\\-]+", "search.config.lang": "en", "search.result.placeholder": "Type to start searching", "search.result.other": "# matching documents", "search.result.none": "No matching documents"}</script>
      
      <script>
        app = initialize({
          base: ".",
          features: [],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>