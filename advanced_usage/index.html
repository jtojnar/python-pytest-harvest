


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.1">
    
    
      
        <title>Advanced Usage - pytest_harvest</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a676eddb.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-usage" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="pytest_harvest" class="md-header-nav__button md-logo" aria-label="pytest_harvest">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            pytest_harvest
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Advanced Usage
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pytest_harvest" class="md-nav__button md-logo" aria-label="pytest_harvest">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    pytest_harvest
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../api_reference/" title="API reference" class="md-nav__link">
      API reference
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Advanced Usage
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Advanced Usage" class="md-nav__link md-nav__link--active">
      Advanced Usage
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-prerequisite-how-to-write-session-teardown-code" class="md-nav__link">
    0- Prerequisite: how to write session teardown code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-collecting-tests-status-and-parameters" class="md-nav__link">
    1- Collecting tests status and parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-storingretrieving-fixtures" class="md-nav__link">
    2- Storing/retrieving fixtures
  </a>
  
    <nav class="md-nav" aria-label="2- Storing/retrieving fixtures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-storing-in-a-variable" class="md-nav__link">
    a- Storing in a variable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-storing-in-a-fixture" class="md-nav__link">
    b- Storing in a fixture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" class="md-nav__link">
    3- Creating "results bags" fixtures to collect test artifacts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-a-synthesis-table" class="md-nav__link">
    4- Creating a Synthesis table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-partial-synthesis-module-function-and-synthesis-tests" class="md-nav__link">
    5- Partial synthesis (module, function) and synthesis tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    Complete example
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-prerequisite-how-to-write-session-teardown-code" class="md-nav__link">
    0- Prerequisite: how to write session teardown code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-collecting-tests-status-and-parameters" class="md-nav__link">
    1- Collecting tests status and parameters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-storingretrieving-fixtures" class="md-nav__link">
    2- Storing/retrieving fixtures
  </a>
  
    <nav class="md-nav" aria-label="2- Storing/retrieving fixtures">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-storing-in-a-variable" class="md-nav__link">
    a- Storing in a variable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-storing-in-a-fixture" class="md-nav__link">
    b- Storing in a fixture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" class="md-nav__link">
    3- Creating "results bags" fixtures to collect test artifacts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-a-synthesis-table" class="md-nav__link">
    4- Creating a Synthesis table
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-partial-synthesis-module-function-and-synthesis-tests" class="md-nav__link">
    5- Partial synthesis (module, function) and synthesis tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#complete-example" class="md-nav__link">
    Complete example
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/smarie/python-pytest-harvest/edit/master/docs/advanced_usage.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="advanced-usage">Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permanent link">&para;</a></h1>
<p>You have seen in the <a href="..">introduction</a> how to use the pre-wired fixtures to perform most comon tasks. The sections below explore, for each topic, the internals that are used behind the scenes, so that you are able to create custom behaviours if the default ones do not match your needs.</p>
<h3 id="0-prerequisite-how-to-write-session-teardown-code">0- Prerequisite: how to write session teardown code<a class="headerlink" href="#0-prerequisite-how-to-write-session-teardown-code" title="Permanent link">&para;</a></h3>
<p>In order to be able to <strong>retrieve</strong> all the information that we will store, we will need to execute our retrieval/synthesis code <strong>at the end of the entire test session</strong>. </p>
<p><code>pytest</code> currently provides several ways to do this:</p>
<ul>
<li>through a test (put it at the end of the latest test file to ensure execution at the end):</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># you can access the session from the injected &#39;request&#39;:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>through a generator (yield) session-scoped fixture (put this in any of your test files or in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># Note: for pytest&lt;3.0 you have to use @pytest.yield_fixture instead</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_cooler_session_finish</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">yield</span>
    <span class="c1"># you can access the session from the injected &#39;request&#39;:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>through a normal session-scoped fixture (put this in any of your test files or in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_session_finish</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_end</span><span class="p">():</span>
        <span class="c1"># you can access the session from the injected &#39;request&#39;:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">_end</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>through the session finish <a href="https://docs.pytest.org/en/latest/reference.html#_pytest.hookspec.pytest_sessionfinish">hook</a> (you have to write this function in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">pytest_sessionfinish</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">exitstatus</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
</code></pre></div>


<p>All seem completely equivalent for the usage of <code>pytest_harvest</code>. I personally prefer the "fixture" style because you can have several of them instead of a monolithic teardown hook. Besides they can be put in the test files so I typically put them as close as possible to the tests that store the data, so as to ensure maintainability (data creation/storage and data retrieval/synthesis code are in the same file).</p>
<h3 id="1-collecting-tests-status-and-parameters">1- Collecting tests status and parameters<a class="headerlink" href="#1-collecting-tests-status-and-parameters" title="Permanent link">&para;</a></h3>
<p>Pytest already stores some information out of the box concerning tests that have run. In addition you can follow <a href="https://docs.pytest.org/en/latest/example/simple.html#making-test-result-information-available-in-fixtures">this example</a> to retrieve more, but it requires you to write a hook so it is not very convenient. </p>
<p>Instead, you can easily retrieve all of that thanks to the <code>get_session_synthesis_dct(session)</code> utility function. For example let's assume you have this parametrized test with a parametrized fixture:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># unparametrized fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">dummy</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;hey there !&quot;</span>

<span class="c1"># parametrized fixture</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">a_number_str</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="c1"># parametrized test using the fixtures</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a_number_str</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">a_number_str</span><span class="p">)</span>
</code></pre></div>


<p>When running it, 4 tests are executed:</p>
<div class="codehilite"><pre><span></span><code>&gt;&gt;&gt; <span class="nv">pytest</span>

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
collected <span class="m">4</span> items                                                              

path/to/test_file.py::test_foo<span class="o">[</span><span class="m">1</span>-hello<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">25</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">1</span>-world<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">50</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">2</span>-hello<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">75</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">2</span>-world<span class="o">]</span> PASSED <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span> <span class="m">4</span> passed in <span class="m">0</span>.11 <span class="nv">seconds</span> <span class="o">===========================</span>
</code></pre></div>


<p>let's retrieve the available information at the end of the session. The easiest way is to write a "last test" and make sure it is executed after all the other as shown below, but there are other ways as <a href="#0-prerequisite-how-to-write-session-teardown-code">shown above</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">get_session_synthesis_dct</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">synth_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">status_details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">synth_dct</span><span class="p">))</span>
</code></pre></div>


<p>It yields</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[1-hello]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0010001659393310547</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str_param&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.013001203536987305</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                     <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[1-world]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str_param&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                     <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[2-hello]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0010001659393310547</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str_param&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span> 
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                      <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[2-world]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str_param&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                      <span class="p">}</span>
            <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>As you can see for each test node id you get a dictionary containing</p>
<ul>
<li><code>'pytest_obj'</code>the object containing the test code</li>
<li><code>'pytest_status'</code> the status and <code>'pytest_duration'</code> the duration of the test</li>
<li><code>'pytest_params'</code>the parameters used in this test (both in the test function AND the fixture)</li>
<li><code>'pytest_status_details'</code> a dictionary containing the status details for each pytest internal stages: setup, call, and teardown. </li>
</ul>
<div class="admonition note">
<p class="admonition-title">status and duration aggregation</p>
<p>that the global status corresponds to an aggregation of the status of each of those stages (setup, call, teardown), but the global duration is only the duration of the "call" stage - after all we do not care about how long it took to setup and teardown.</p>
</div>
<p>In addition, you can also use the following companion methods : </p>
<ul>
<li><code>filter_session_items(session, filter=None)</code> is the filtering method used behind the scenes. <code>pytest_item_matches_filter</code> is the inner method used to test if a single item matches the filter.</li>
<li><code>get_all_pytest_param_names(session)</code> lists all unique parameter names used, with optional filtering capabilities</li>
<li><code>is_pytest_incomplete(item)</code>, <code>get_pytest_status(item)</code>, <code>get_pytest_param_names(item)</code> and <code>get_pytest_params(item)</code> can be used to analyse a specific item in <code>session.items</code> directly without creating the dictionary.</li>
</ul>
<p>Finally let's have a closer look above. It <strong>seems</strong> that after all we have collected the fixtures, right ? For example we see <code>'a_number_str_param': 2</code>. But beware, this is not the fixture. It is the parameter used by the fixture <code>'a_number_str'</code>. To be convinced look at its type: it is an integer, not a string! A more obvious way to confirm that the fixtures are not available, is to see that the <code>'dummy'</code> fixture does not appear at all: indeed it had no parameters.</p>
<p>To conclude: the <code>get_session_synthesis_dct(session)</code> utility function allows you to collect many information about the tests, but not the fixtures. To do that you have to use the mechanisms below.</p>
<h3 id="2-storingretrieving-fixtures">2- Storing/retrieving fixtures<a class="headerlink" href="#2-storingretrieving-fixtures" title="Permanent link">&para;</a></h3>
<p>You can either choose to store fixtures in a plain old variable, or in another, session-scoped, fixture. Both can be achieved using the same decorator <code>@saved_fixture(store)</code>.</p>
<h4 id="a-storing-in-a-variable">a- Storing in a variable<a class="headerlink" href="#a-storing-in-a-variable" title="Permanent link">&para;</a></h4>
<p>Let's create a store. It should be a dict-like object:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Create a global store</span>
<span class="n">STORE</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</code></pre></div>


<p>In order to store all created fixture values in this object, simply decorate your fixture with <code>@saved_fixture(STORE)</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nd">@saved_fixture</span><span class="p">(</span><span class="n">STORE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fix</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each returned fixture value will be saved in the global store&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
</code></pre></div>


<p>You can then retrieve the available information at the end of the session (put this in your <a href="#0-prerequisite-how-to-write-session-teardown-code">session teardown</a>):</p>
<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">STORE</span><span class="p">[</span><span class="s1">&#39;my_fix&#39;</span><span class="p">]))</span>
</code></pre></div>


<p>Each saved fixture appears as an ordered dictionary stored under a global key that has its name (here 'my_fix'). In this dictionary, the keys are the test node ids, and the values are the fixture values:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="s1">&#39;path/to/test_file.py::test_foo[1]&#39;</span><span class="o">:</span> <span class="s1">&#39;my_fix #1&#39;</span><span class="p">,</span> 
<span class="s1">&#39;path/to/test_file.py::test_foo[2]&#39;</span><span class="o">:</span> <span class="s1">&#39;my_fix #2&#39;</span><span class="p">}</span>
</code></pre></div>


<p>Note: you can change the key used in the global storage with the <code>key=</code> argument of <code>@saved_fixture</code>. </p>
<h4 id="b-storing-in-a-fixture">b- Storing in a fixture<a class="headerlink" href="#b-storing-in-a-fixture" title="Permanent link">&para;</a></h4>
<p>You might want your store to be a fixture itself, instead of a global variable. It is possible if it is session- or module-scoped (in the same module than where it is used). Simply use its name in <code>@saved_fixture</code> and it will work as expected. </p>
<p>This enables you to make the code even more readable because you can put the synthesis code in the teardown part of the storage fixture:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nd">@saved_fixture</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fix</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each returned fixture value will be saved in the global store&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="c1"># -- the global storage fixture and synthesis creator --</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
    <span class="c1"># setup: init the store</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">store</span>
    <span class="c1"># teardown: here you can collect all</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">store</span><span class="p">[</span><span class="s1">&#39;my_fix&#39;</span><span class="p">]))</span>
</code></pre></div>


<div class="admonition note">
<p class="admonition-title">other teardown hooks</p>
<p>If you use another teardown hook, you can still retrieve your <code>'store'</code> fixture by using the <code>get_fixture_value(request, 'store')</code> utility function provided in this library. </p>
</div>
<div class="admonition note">
<p class="admonition-title">yield_fixture</p>
<p>In old versions of pytest, you have to use <code>@pytest.yield_fixture</code> to be allowed to use <code>yield</code> in a fixture.</p>
</div>
<h3 id="3-creating-results-bags-fixtures-to-collect-test-artifacts">3- Creating "results bags" fixtures to collect test artifacts<a class="headerlink" href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" title="Permanent link">&para;</a></h3>
<p>Now we are able to store fixtures. But what about the data that we create <strong>during</strong> the tests ? It can be accuracy results, etc.</p>
<p>For this, simply use <code>create_results_bag_fixture()</code> to create "results bags" fixtures where you can put any data you want:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">create_results_bag_fixture</span>

<span class="k">def</span> <span class="nf">my_algorithm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># let&#39;s return a random accuracy !</span>
    <span class="k">return</span> <span class="n">random</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;my dataset #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;algo_param&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_my_app_bench</span><span class="p">(</span><span class="n">algo_param</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">results_bag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This test applies the algorithm with various parameters (`algo_param`)</span>
<span class="sd">    on various datasets (`dataset`). Accuracies are stored in a results</span>
<span class="sd">    bag (`results_bag`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># apply the algorithm with param `algo_param` on dataset `dataset`</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">my_algorithm</span><span class="p">(</span><span class="n">algo_param</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="c1"># store it in the results bag</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy</span>

<span class="c1"># -- the results bag fixture --</span>
<span class="c1"># note: depending on your pytest version, the name used by pytest might be</span>
<span class="c1"># the variable name (left) or the one you provide in the &#39;name&#39; argument so </span>
<span class="c1"># make sure they are identical! </span>
<span class="n">results_bag</span> <span class="o">=</span> <span class="n">create_results_bag_fixture</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;results_bag&quot;</span><span class="p">)</span>

<span class="c1"># -- the global storage fixture and synthesis creator --</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># setup: init the store</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">store</span>
    <span class="c1"># teardown: here you can collect all</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">store</span><span class="p">[</span><span class="s1">&#39;results_bag&#39;</span><span class="p">]))</span>
</code></pre></div>


<p>We can see the correct results collected:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[A-1]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.2630766637159053</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[A-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.6720533462346249</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[B-1]&#39;</span><span class="o">:</span>
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.9121353916881674</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[B-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.9401074040573346</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[C-1]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.01619034700438804</span><span class="p">},</span>
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[C-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.8027244886806986</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>We can of course combine this with the test status and parameters (we saw <a href="#1-collecting-tests-status-and-parameters">above</a> how to collect them) if we want to create a synthesis table. This complete story will be available on <a href="https://github.com/smarie/pytest-patterns">pytest-patterns</a>.</p>
<div class="admonition note">
<p class="admonition-title">results bag fixtures' storage</p>
<p>You declare the storage used in the arguments of <code>create_results_bag_fixture</code>. As this relies on <code>@saved_fixture</code>, you can use both a variable or a session/module-scoped fixture name as we saw in previous chapter. </p>
</div>
<h3 id="4-creating-a-synthesis-table">4- Creating a Synthesis table<a class="headerlink" href="#4-creating-a-synthesis-table" title="Permanent link">&para;</a></h3>
<p>Now that we know</p>
<ul>
<li>how to retrieve pytest status and parameters</li>
<li>how to store and retrieve fixtures</li>
<li>and how to store and retrieve applicative results</li>
</ul>
<p>We can create a synthesis table containing all information available. This is very easy: instead of calling <code>get_session_synthesis_dct</code> with no parameters, give it your <code>store</code> object. Since we want to create a table, we will use the <code>flatten</code> and <code>flatten_more</code> options so that the result does not contain nested dictionaries for the parameters, fixtures, and result bags. Finally we decide that we want the durations expressed in ms (pytest measures them in seconds by default).</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># retrieve the synthesis, merged with the fixture store</span>
<span class="n">results_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">fixture_store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> 
                                        <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flatten_more</span><span class="o">=</span><span class="s1">&#39;results_bag&#39;</span><span class="p">,</span>
                                        <span class="n">durations_in_ms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<p>We can print the first entry:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results_dct</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>

<span class="p">{</span><span class="s1">&#39;pytest_obj&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">test_my_app_bench</span> <span class="n">at</span> <span class="mh">0x0000000004FF6A60</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s1">&#39;pytest_status&#39;</span><span class="p">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pytest_duration_ms&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
 <span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
 <span class="s1">&#39;algo_param&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mf">0.2630766637159053</span><span class="p">}</span>
</code></pre></div>


<p>We see that all information is available at the same level: pytest status and duration, parameters (<code>dataset</code> and <code>algo_param</code>), and results (<code>accuracy</code>).</p>
<p>Transforming such a flattened dictionary in a table is very easy with <code>pandas</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">results_dct</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="c1"># (a) remove the full test id path</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span> \
                             <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">test_id</span><span class="p">:</span> <span class="n">test_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># (b) drop pytest object column</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;pytest_obj&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<p>And finally we can use <code>pandas</code> or <code>tabulate</code> to export the result in csv or markdown format:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># csv format</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">())</span>

<span class="c1"># github markdown format</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
</code></pre></div>


<table>
<thead>
<tr>
<th></th>
<th>status</th>
<th>duration_ms</th>
<th>algo_param</th>
<th>dataset</th>
<th>accuracy</th>
</tr>
</thead>
<tbody>
<tr>
<td>test_my_app_bench[A-1]</td>
<td>passed</td>
<td>1.00017</td>
<td>1</td>
<td>A</td>
<td>0.313807</td>
</tr>
<tr>
<td>test_my_app_bench[A-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>A</td>
<td>0.0459802</td>
</tr>
<tr>
<td>test_my_app_bench[B-1]</td>
<td>passed</td>
<td>0</td>
<td>1</td>
<td>B</td>
<td>0.638511</td>
</tr>
<tr>
<td>test_my_app_bench[B-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>B</td>
<td>0.10418</td>
</tr>
<tr>
<td>test_my_app_bench[C-1]</td>
<td>passed</td>
<td>0</td>
<td>1</td>
<td>C</td>
<td>0.287151</td>
</tr>
<tr>
<td>test_my_app_bench[C-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>C</td>
<td>0.19437</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Duration calculation</p>
<p>The duration field is directly extracted from <code>pytest</code>. Currently <code>pytest</code> computes durations using the <code>time</code> method, which might not be as accurate as other methods - see opened discussion <a href="https://github.com/pytest-dev/pytest/issues/4391">here</a>. If you need more precise duration benchmarking <strong>now</strong>, of if you need to measure the duration of a specific sub-function instead of the duration of the whole test function call, use <a href="https://github.com/ionelmc/pytest-benchmark">pytest-benchmark</a>. In the long run, the author thinks that <code>pytest</code> will hopefully provide more precise duration estimates, and therefore you will be able to get similar results in the table outputted above (+ possibly a <code>@repeat(n)</code> parameter on top of your test function if you wish to repeat it several times and compare the durations).</p>
</div>
<h3 id="5-partial-synthesis-module-function-and-synthesis-tests">5- Partial synthesis (module, function) and synthesis tests<a class="headerlink" href="#5-partial-synthesis-module-function-and-synthesis-tests" title="Permanent link">&para;</a></h3>
<p>We have seen <a href="#1-collecting-tests-status-and-parameters">above</a> that you can get the pytest <code>session</code> object from many different teardown hooks. In addition, you can even access it from inside a test! In that case all information will not be available, but if the synthesis test is located <strong>after</strong> the test function of interest in execution order, it will be ok.</p>
<p>To be sure to only get results you're interested in, the special <code>filter</code> argument allows you to only select parts of the test nodes to create the synthesis:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># a module-scoped store</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

<span class="c1"># results bag fixture</span>
<span class="n">my_results</span> <span class="o">=</span> <span class="n">create_results_bag_fixture</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_results&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">my_results</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
    <span class="c1"># get partial results concerning `test_foo`</span>
    <span class="n">results_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">test_foo</span><span class="p">,</span> 
                                            <span class="n">fixture_store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

    <span class="c1"># you can assert / report using the `results_dct` here</span>
</code></pre></div>


<p>See <code>help(get_session_synthesis_dct)</code> for details: for example you can include in this filter a list, and it can contain module names too.</p>
<h3 id="complete-example">Complete example<a class="headerlink" href="#complete-example" title="Permanent link">&para;</a></h3>
<p>A module-scoped complete example with parameters, fixtures, and results bag can be found in two versions:</p>
<ul>
<li><a href="https://github.com/smarie/python-pytest-harvest/tree/master/pytest_harvest/tests/test_doc_example.py">here</a> with no customization (leveraging the default fixtures)</li>
<li><a href="https://github.com/smarie/python-pytest-harvest/tree/master/pytest_harvest/tests/test_doc_example_custom.py">here</a> to perform the exact same behaviour but with custom store and results bag.</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../changelog/" title="Changelog" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Changelog
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.c51dfa35.min.js"></script>
      <script src="../assets/javascripts/bundle.eaaa3931.min.js"></script><script id="__lang" type="application/json">{"search.config.separator": "[\\s\\-]+", "search.config.lang": "en", "search.result.other": "# matching documents", "search.result.none": "No matching documents", "search.config.pipeline": "trimmer, stopWordFilter", "clipboard.copy": "Copy to clipboard", "search.result.one": "1 matching document", "clipboard.copied": "Copied to clipboard", "search.result.placeholder": "Type to start searching"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.58d22e8e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>